@model ERManager.ViewModels.Homes.HomePageViewModel
 @using System.Globalization
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid p-4">
    <!-- Overview Cards for Financial Metrics -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2 g-sm-3 mb-4">
        @{
            var cards = new[]
            {
        new { Title = "کڕین", Value = Model.TotalPurchase, Icon = "fas fa-file-invoice-dollar", Color = "success" },
        new { Title = "فڕۆش", Value = Model.TotalSales, Icon = "fas fa-cash-register", Color = "primary" },
        new { Title = "مەسروف", Value = Model.TotalExpenses, Icon = "fas fa-money-bill-wave", Color = "warning" },
        new { Title = "پارەی وەرگیراو", Value = Model.ContactPaymentInflow, Icon = "fas fa-arrow-circle-down", Color = "success" },
        new { Title = "پارەی دراو", Value = Model.ContactPaymentOutflow, Icon = "fas fa-arrow-circle-up", Color = "danger" },
        new { Title = "هاتووی قاسە", Value = Model.MoneyTransactionIn, Icon = "fas fa-arrow-circle-down", Color = "success" },
        new { Title = "دەرچووی قاسە", Value = Model.MoneyTransactionOut, Icon = "fas fa-arrow-circle-up", Color = "danger" }
        };
        }

        @foreach (var card in cards)
        {
            <div class="col m-b-30">
                <div class="card dashboard-card shadow-sm border-start border-5 border-@card.Color">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div class="me-2">
                            <h6 class="card-title mb-1">@card.Title</h6>
                            <p class="card-text fw-bold mb-0">@card.Value.ToString("N0")</p>
                            <small class="text-muted">Updated just now</small>
                        </div>
                        <i class="@card.Icon card-icon fs-2 text-@card.Color"></i>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Right Side: Recent Activities -->
        <div class="col-lg-9 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">چالاکی ئەمڕۆ</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Responsive Table Wrapper -->
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">بەروار</th>
                                    <th scope="col">جۆر</th>
                                    <th scope="col">ناو</th>
                                    <th scope="col">موبایل</th>
                                    <th scope="col">حاڵەت</th>
                                    <th scope="col">بڕ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentActivities != null && Model.RecentActivities.Any())
                                {
                                    foreach (var activity in Model.RecentActivities)
                                    {
                                        <tr>
                                            <td>@activity.CreatedAt.ToShortDateString()</td>
                                            <td>@activity.ActivityName</td>
                                            <td>
                                                @if (activity.ContactId != 0)
                                                {
                                                    <a asp-controller="Contacts"
                                                       asp-action="ContactBalance"
                                                       asp-route-contactId="@activity.ContactId"
                                                       asp-route-startDate="@DateTime.Now.Date.ToString("yyyy-MM-dd")"
                                                       asp-route-endDate="@DateTime.Now.AddMonths(1).ToString("yyyy-MM-dd")">
                                                        @activity.ContactName
                                                    </a>
                                                }
                                                else
                                                {
                                                    @activity.ContactName
                                                }
                                            </td>
                                            <td><a href="tel:@activity.ContacPhone">@activity.ContacPhone</a></td>
                                            <td>
                                                <span class="badge @((activity.Status == "Completed") ? "bg-success" : "bg-warning")">@activity.Status</span>
                                            </td>
                                            <td>@activity.Amount.ToString("N0")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">No recent activities found.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Chart for Monthly Totals -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Monthly Sales Totals</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Left Side: Quick Links and Best Customer -->
        <div class="col-lg-3 mb-4">
            <!-- Quick Links -->
            <div class="card quick-links-card shadow-sm mb-4 border-0">
                <div class="card-header bg-gradient-primary text-center py-3">
                    <h5 class="card-title mb-0">Quick Links</h5>
                </div>
                <div class="card-body px-3 py-4">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <a asp-controller="PurchaseInvoices" asp-action="Create" class="quick-link-item">
                                <i class="fas fa-file-invoice-dollar me-2"></i>کڕینێکی نوێ
                            </a>
                        </li>
                        <li class="mb-3">
                            <a asp-controller="SaleInvoices" asp-action="Create" class="quick-link-item">
                                <i class="fas fa-cash-register me-2"></i>فڕۆشتنێکی نوێ
                            </a>
                        </li>
                        <li class="mb-3">
                            <a asp-controller="ContactPayments" asp-action="Create" class="quick-link-item">
                                <i class="fas fa-money-check-alt me-2"></i>پارەدان
                            </a>
                        </li>
                        <li>
                            <a asp-controller="ContactPayments" asp-action="CreateInFlow" class="quick-link-item">
                                <i class="fas fa-money-check-alt me-2"></i>پارەوەرگرتن
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Best Customer -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Best Customer</h5>
                </div>
                <div class="card-body">
                    @if (Model.BestCustomer != null)
                    {
                        foreach (var item in Model.BestCustomer)
                        {
                            <h6 class="card-subtitle mb-1">@item.CustomerName</h6>
                            <p class="card-text">باڵانس: @item.TotalSales.ToString("N0")</p>
                        }
                    }
                    else
                    {
                        <p class="card-text">No customer data available.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/assets/libs/chart.js/chart.min.js" asp-append-version="true"></script>
    <script type="text/javascript">
        // Get the data from the model passed to the view (assuming it's named Model)
        var monthlyTotals = @Html.Raw(Json.Serialize(Model));

        // Log to check if data is passed correctly
        console.log(monthlyTotals);

        // Map the data to two arrays: sales data and month names
        var monthlySales = monthlyTotals.map(item => item.TotalAmount);
        var months = monthlyTotals.map(item => item.Month);

        // Check that the arrays are populated correctly
        console.log(monthlySales, months);

        // Get the canvas element by its ID and get the context for Chart.js
        var ctx = document.getElementById('monthlySalesChart').getContext('2d');

        // Initialize the Chart.js chart
        new Chart(ctx, {
            type: 'line',  // Chart type: line chart
            data: {
                labels: months,  // X-axis: months
                datasets: [{
                    label: 'Monthly Sales Totals',  // Label for the dataset
                    data: monthlySales,  // Y-axis: sales data
                    borderColor: 'rgba(75, 192, 192, 1)',  // Line color
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',  // Fill color
                    borderWidth: 2,  // Border width of the line
                    tension: 0.4  // Smoothness of the line curve
                }]
            },
            options: {
                responsive: true,  // Make the chart responsive
                maintainAspectRatio: false,  // Allow resizing of the chart
                scales: {
                    y: {
                        beginAtZero: true,  // Start Y-axis from 0
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)'  // Y-axis grid color
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)'  // X-axis grid color
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        enabled: true  // Enable tooltips on hover
                    }
                }
            }
        });
    </script>


}

<style>
    .dashboard-card {
        transition: transform 0.3s ease-in-out, box-shadow 0.3s;
    }

        .dashboard-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

    .card-icon {
        font-size: 2rem;
    }

    .quick-link-item {
        display: flex;
        align-items: center;
        color: #4a4a4a;
        transition: all 0.3s ease;
        border-radius: 6px;
        text-decoration: none;
    }

        .quick-link-item i {
            color: #007bff;
            transition: color 0.3s ease;
            margin-left:15px;
        }

        .quick-link-item:hover {
            text-decoration: none;
            color: #007bff;
        }
</style>
